// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User model for future extensibility (not used in simple password auth)
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Session tracking (optional, for audit purposes)
model Session {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
}

// Amazon Advertising API credentials and selected profile
model AmazonCredential {
  id           String   @id @default(cuid())
  accessToken  String
  refreshToken String
  expiresAt    DateTime
  profileId    String?
  profileName  String?
  countryCode  String?
  marketplace  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Amazon Advertising Campaign (SP, SB, SD)
model Campaign {
  id           String    @id
  profileId    String
  type         String    // SP, SB, SD
  name         String
  state        String    // enabled, paused, archived
  budget       Float?
  budgetType   String?   // daily
  startDate    String?
  endDate      String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  syncedAt     DateTime?
  adGroups     AdGroup[]
  metrics      CampaignMetric[]

  @@index([profileId])
  @@index([type])
  @@index([state])
}

// Ad Group within a Campaign
model AdGroup {
  id           String    @id
  campaignId   String
  campaign     Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  name         String
  state        String    // enabled, paused, archived
  defaultBid   Float?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  keywords     Keyword[]

  @@index([campaignId])
}

// Keyword within an Ad Group
model Keyword {
  id           String    @id
  adGroupId    String
  adGroup      AdGroup   @relation(fields: [adGroupId], references: [id], onDelete: Cascade)
  keywordText  String
  matchType    String    // exact, phrase, broad
  state        String    // enabled, paused, archived
  bid          Float?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  metrics      KeywordMetric[]

  @@index([adGroupId])
  @@index([matchType])
}

// Daily metrics for a Campaign
model CampaignMetric {
  id           String    @id @default(cuid())
  campaignId   String
  campaign     Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  date         String    // YYYYMMDD format
  impressions  Int       @default(0)
  clicks       Int       @default(0)
  cost         Float     @default(0)
  orders       Int       @default(0)
  sales        Float     @default(0)
  createdAt    DateTime  @default(now())

  @@unique([campaignId, date])
  @@index([date])
}

// Daily metrics for a Keyword
model KeywordMetric {
  id           String    @id @default(cuid())
  keywordId    String
  keyword      Keyword   @relation(fields: [keywordId], references: [id], onDelete: Cascade)
  date         String    // YYYYMMDD format
  impressions  Int       @default(0)
  clicks       Int       @default(0)
  cost         Float     @default(0)
  orders       Int       @default(0)
  sales        Float     @default(0)
  createdAt    DateTime  @default(now())

  @@unique([keywordId, date])
  @@index([date])
}

// Sync state tracking for each profile
model SyncState {
  id           String    @id @default(cuid())
  profileId    String    @unique
  lastSyncAt   DateTime?
  syncStatus   String    @default("idle") // idle, syncing, completed, failed
  error        String?
  updatedAt    DateTime  @updatedAt
}

// Safety limits configuration (single row per installation)
model SafetyLimit {
  id                 String   @id @default(cuid())
  maxBidChangePct    Float    @default(50)     // Max bid change % per action
  maxBudgetChangePct Float    @default(100)    // Max budget change % per action
  maxDailySpend      Float?                    // Absolute daily spend cap
  minBidFloor        Float    @default(0.02)   // Minimum bid allowed
  maxBidCeiling      Float    @default(100)    // Maximum bid allowed
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// Audit log entry for tracking all actions
model AuditEntry {
  id          String   @id @default(cuid())
  timestamp   DateTime @default(now())
  actorType   String   // 'user' | 'agent' | 'rule'
  actorId     String?  // session ID, agent key, rule ID
  actionType  String   // 'bid_change', 'budget_change', 'status_change', etc.
  entityType  String   // 'campaign', 'keyword', 'ad_group'
  entityId    String
  entityName  String?  // Human-readable name for display
  beforeState String?  // JSON string of state before action
  afterState  String?  // JSON string of state after action
  reason      String?  // Reason for the action
  success     Boolean  @default(true)
  errorMsg    String?  // Error message if action failed

  @@index([timestamp])
  @@index([entityType, entityId])
  @@index([actorType])
  @@index([actionType])
}
