# Plan 03-03: Sync Engine

## Goal
Implement two-phase sync pattern with atomic database persistence.

## Requirements Covered
- SYNC-03: Respect rate limits via queue
- SYNC-06: Two-phase pattern (fetch then atomic persist)

## Tasks

### 1. Create Sync Service
Main sync orchestrator that coordinates fetch and persist phases.

### 2. Implement Fetch Phase
Collect all data from API into memory structures.

### 3. Implement Persist Phase
Atomic database transaction to upsert all data.

### 4. Add Sync State Management
Track sync status, last sync time, errors.

### 5. Add Error Handling
Retry logic, partial failure recovery.

## Sync Flow

```typescript
// lib/sync.ts

async function syncCampaignData(profileId: string): Promise<SyncResult> {
  // 1. Update sync state to "syncing"
  await setSyncStatus(profileId, "syncing")

  try {
    // 2. FETCH PHASE - collect all data
    const campaigns = await fetchAllCampaigns(profileId)
    const adGroups = await fetchAllAdGroups(profileId, campaigns)
    const keywords = await fetchAllKeywords(profileId, adGroups)

    // 3. PERSIST PHASE - atomic transaction
    await prisma.$transaction(async (tx) => {
      // Upsert campaigns
      for (const campaign of campaigns) {
        await tx.campaign.upsert({...})
      }
      // Upsert ad groups
      for (const adGroup of adGroups) {
        await tx.adGroup.upsert({...})
      }
      // Upsert keywords
      for (const keyword of keywords) {
        await tx.keyword.upsert({...})
      }
    })

    // 4. Update sync state to "completed"
    await setSyncStatus(profileId, "completed")
    return { success: true }
  } catch (error) {
    // 5. Update sync state to "failed"
    await setSyncStatus(profileId, "failed", error.message)
    return { success: false, error: error.message }
  }
}
```

## Verification
- [ ] Sync fetches all campaign types
- [ ] Data persists in transaction
- [ ] Sync state updates correctly
- [ ] Errors are handled gracefully

## Estimated Complexity
High - Core sync logic with transaction handling.
