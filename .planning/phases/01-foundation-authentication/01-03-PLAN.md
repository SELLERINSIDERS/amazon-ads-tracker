---
phase: 01-foundation-authentication
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - app/(dashboard)/layout.tsx
  - app/(dashboard)/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can access dashboard after login"
    - "User session persists across browser refresh"
    - "User can log out from dashboard"
    - "Logout returns user to login page"
  artifacts:
    - path: "app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with logout"
      contains: "LogoutButton"
    - path: "app/(dashboard)/page.tsx"
      provides: "Dashboard home page"
      contains: "verifySession"
  key_links:
    - from: "app/(dashboard)/layout.tsx"
      to: "components/logout-button.tsx"
      via: "component import"
      pattern: "import.*LogoutButton"
    - from: "app/(dashboard)/page.tsx"
      to: "lib/dal.ts"
      via: "session verification"
      pattern: "verifySession"
---

<objective>
Create protected dashboard shell with layout, logout functionality, and verify complete auth flow.

Purpose: Complete the authentication phase with a working protected area and full login/logout cycle.
Output: Dashboard page that only authenticated users can access, with working logout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create protected dashboard layout and home page</name>
  <files>
    app/(dashboard)/layout.tsx
    app/(dashboard)/page.tsx
  </files>
  <action>
    1. Create app/(dashboard)/layout.tsx with navigation and logout:
       ```typescript
       import { LogoutButton } from '@/components/logout-button'

       export default function DashboardLayout({
         children,
       }: {
         children: React.ReactNode
       }) {
         return (
           <div className="min-h-screen bg-gray-50">
             {/* Header */}
             <header className="bg-white border-b border-gray-200">
               <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                 <div className="flex justify-between items-center h-16">
                   <div className="flex items-center">
                     <h1 className="text-xl font-semibold text-gray-900">
                       PPC Command Center
                     </h1>
                   </div>
                   <div className="flex items-center space-x-4">
                     <LogoutButton />
                   </div>
                 </div>
               </div>
             </header>

             {/* Main content */}
             <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
               {children}
             </main>
           </div>
         )
       }
       ```

    2. Create app/(dashboard)/page.tsx with session verification (from research Pattern - protected Server Component):
       ```typescript
       import { verifySession } from '@/lib/dal'

       export default async function DashboardPage() {
         // This will redirect to /login if not authenticated
         const session = await verifySession()

         return (
           <div className="space-y-6">
             <div>
               <h2 className="text-2xl font-bold text-gray-900">Dashboard</h2>
               <p className="mt-1 text-sm text-gray-500">
                 Welcome to the PPC Command Center
               </p>
             </div>

             {/* Placeholder cards for future dashboard content */}
             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
               <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                 <h3 className="text-sm font-medium text-gray-500">Total Spend</h3>
                 <p className="mt-2 text-3xl font-semibold text-gray-900">$0.00</p>
                 <p className="mt-1 text-sm text-gray-500">Coming in Phase 4</p>
               </div>
               <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                 <h3 className="text-sm font-medium text-gray-500">ACoS</h3>
                 <p className="mt-2 text-3xl font-semibold text-gray-900">0%</p>
                 <p className="mt-1 text-sm text-gray-500">Coming in Phase 4</p>
               </div>
               <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                 <h3 className="text-sm font-medium text-gray-500">Campaigns</h3>
                 <p className="mt-2 text-3xl font-semibold text-gray-900">0</p>
                 <p className="mt-1 text-sm text-gray-500">Coming in Phase 3</p>
               </div>
               <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                 <h3 className="text-sm font-medium text-gray-500">Agent Status</h3>
                 <p className="mt-2 text-3xl font-semibold text-gray-900">--</p>
                 <p className="mt-1 text-sm text-gray-500">Coming in Phase 7</p>
               </div>
             </div>

             {/* Connection status placeholder */}
             <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
               <h3 className="text-lg font-medium text-gray-900">Amazon Ads Connection</h3>
               <p className="mt-2 text-sm text-gray-500">
                 Not connected. Amazon API integration will be available in Phase 2.
               </p>
             </div>
           </div>
         )
       }
       ```

    3. Delete or update the default app/page.tsx to redirect:
       - Option A: Delete app/page.tsx (middleware handles / redirect)
       - Option B: Keep minimal app/page.tsx that redirects

       Use Option A (delete) since middleware already handles root path.
  </action>
  <verify>
    - After login, dashboard page displays with header and placeholder cards
    - Logout button visible in header
    - Refreshing dashboard page maintains session (no redirect to login)
    - Clicking logout returns to login page
    - After logout, visiting /dashboard redirects to /login
  </verify>
  <done>Protected dashboard shell with layout and logout functionality</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify complete authentication flow</name>
  <what-built>
    Complete authentication system for Phase 1:
    - Login page with password validation
    - Session management with iron-session
    - Middleware route protection
    - Protected dashboard with logout
  </what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev`
    2. Open http://localhost:3001 in browser
    3. Verify: You are redirected to /login
    4. Enter wrong password, click Sign In
    5. Verify: Error message "Invalid password" appears
    6. Enter correct password (value of PPC_DASHBOARD_PASSWORD from .env.local)
    7. Verify: You are redirected to /dashboard
    8. Verify: Dashboard shows header with "PPC Command Center" and Logout button
    9. Verify: Dashboard shows placeholder metric cards
    10. Refresh the page (Cmd+R or F5)
    11. Verify: You remain on /dashboard (session persists)
    12. Click Logout button
    13. Verify: You are redirected to /login
    14. Try to visit http://localhost:3001/dashboard directly
    15. Verify: You are redirected to /login (session destroyed)
    16. Open DevTools > Application > Cookies
    17. Verify: After logout, session cookie is cleared

    Run database check:
    ```bash
    npx prisma studio
    ```
    18. Verify: Prisma Studio opens and shows User/Session tables (empty is fine)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe specific issues</resume-signal>
</task>

</tasks>

<verification>
Phase 1 Success Criteria (from ROADMAP.md):
1. User can log in with password from PPC_DASHBOARD_PASSWORD env var - VERIFIED
2. User session persists across browser refresh - VERIFIED
3. User can log out from any page - VERIFIED (logout button in dashboard header)
4. Unauthenticated users are redirected to login page - VERIFIED
5. Database schema is created and migrations run successfully - VERIFIED (Prisma Studio)
</verification>

<success_criteria>
- AUTH-01: Login works with PPC_DASHBOARD_PASSWORD
- AUTH-02: Session persists across refresh
- AUTH-03: Logout works from dashboard
- AUTH-04: Unauthenticated users redirected to login
- All 5 phase success criteria met
</success_criteria>

<output>
After completion and human approval, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md`
</output>
