---
phase: 01-foundation-authentication
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - middleware.ts
  - app/(auth)/login/page.tsx
  - app/(auth)/login/actions.ts
  - app/(auth)/layout.tsx
  - components/logout-button.tsx
autonomous: true

must_haves:
  truths:
    - "User can log in with correct password"
    - "User cannot log in with wrong password"
    - "User session is created on successful login"
    - "Unauthenticated users are redirected to login"
  artifacts:
    - path: "middleware.ts"
      provides: "Route protection"
      contains: "protectedRoutes"
    - path: "app/(auth)/login/page.tsx"
      provides: "Login UI"
      contains: "useActionState"
    - path: "app/(auth)/login/actions.ts"
      provides: "Login/logout server actions"
      exports: ["login", "logout"]
  key_links:
    - from: "middleware.ts"
      to: "lib/session.ts"
      via: "session check"
      pattern: "getIronSession"
    - from: "app/(auth)/login/actions.ts"
      to: "lib/session.ts"
      via: "session creation"
      pattern: "session\\.save"
    - from: "app/(auth)/login/actions.ts"
      to: "lib/auth.ts"
      via: "password validation"
      pattern: "validateDashboardPassword"
---

<objective>
Implement authentication system with login page, server actions, and middleware route protection.

Purpose: Enable users to authenticate with the dashboard password and protect routes from unauthenticated access.
Output: Working login/logout flow with session persistence and route guards.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create middleware for route protection</name>
  <files>
    middleware.ts
  </files>
  <action>
    1. Create middleware.ts at project root (from research Pattern 5):
       ```typescript
       import { NextRequest, NextResponse } from 'next/server'
       import { getIronSession } from 'iron-session'
       import { sessionOptions, SessionData } from './lib/session'

       const protectedRoutes = ['/dashboard', '/settings', '/campaigns', '/keywords', '/reports', '/audit', '/chat']
       const publicRoutes = ['/login']

       export async function middleware(req: NextRequest) {
         const path = req.nextUrl.pathname
         const isProtectedRoute = protectedRoutes.some(route => path.startsWith(route))
         const isPublicRoute = publicRoutes.includes(path)

         // Root path handling
         if (path === '/') {
           const session = await getIronSession<SessionData>(req.cookies, sessionOptions)
           if (session.isLoggedIn) {
             return NextResponse.redirect(new URL('/dashboard', req.nextUrl))
           }
           return NextResponse.redirect(new URL('/login', req.nextUrl))
         }

         // Optimistic check: only read cookie (no DB queries in Edge Runtime)
         const session = await getIronSession<SessionData>(req.cookies, sessionOptions)

         if (isProtectedRoute && !session.isLoggedIn) {
           return NextResponse.redirect(new URL('/login', req.nextUrl))
         }

         if (isPublicRoute && session.isLoggedIn && path === '/login') {
           return NextResponse.redirect(new URL('/dashboard', req.nextUrl))
         }

         return NextResponse.next()
       }

       export const config = {
         matcher: ['/((?!api|_next/static|_next/image|.*\\.png$|.*\\.ico$).*)'],
       }
       ```

    IMPORTANT: Per research, middleware runs in Edge Runtime - do NOT import bcrypt, prisma, or any Node.js-specific modules here. Only use iron-session for cookie reading.
  </action>
  <verify>
    - `npm run dev` starts without middleware errors
    - Visiting http://localhost:3001/ redirects to /login
    - No Edge Runtime compatibility errors in console
  </verify>
  <done>Middleware protects routes and redirects unauthenticated users to login</done>
</task>

<task type="auto">
  <name>Task 2: Create login page and authentication server actions</name>
  <files>
    app/(auth)/login/page.tsx
    app/(auth)/login/actions.ts
    app/(auth)/layout.tsx
    components/logout-button.tsx
  </files>
  <action>
    1. Create app/(auth)/layout.tsx (simple centered layout for auth pages):
       ```typescript
       export default function AuthLayout({
         children,
       }: {
         children: React.ReactNode
       }) {
         return (
           <div className="min-h-screen flex items-center justify-center bg-gray-50">
             {children}
           </div>
         )
       }
       ```

    2. Create app/(auth)/login/actions.ts with server actions (from research Pattern 4):
       ```typescript
       'use server'

       import { redirect } from 'next/navigation'
       import { getSession } from '@/lib/session'
       import { validateDashboardPassword } from '@/lib/auth'
       import { z } from 'zod'

       const loginSchema = z.object({
         password: z.string().min(1, 'Password is required'),
       })

       export type LoginState = {
         error?: string
         errors?: {
           password?: string[]
         }
       }

       export async function login(
         prevState: LoginState | undefined,
         formData: FormData
       ): Promise<LoginState> {
         const validatedFields = loginSchema.safeParse({
           password: formData.get('password'),
         })

         if (!validatedFields.success) {
           return {
             errors: validatedFields.error.flatten().fieldErrors,
           }
         }

         const { password } = validatedFields.data

         // Validate against environment variable
         const isValid = validateDashboardPassword(password)

         if (!isValid) {
           return { error: 'Invalid password' }
         }

         // Create session - IMPORTANT: session operations outside try/catch per research
         const session = await getSession()
         session.userId = 'dashboard-user'
         session.isLoggedIn = true
         await session.save()

         // redirect() must be called outside try/catch (throws internally)
         redirect('/dashboard')
       }

       export async function logout() {
         const session = await getSession()
         session.destroy()
         redirect('/login')
       }
       ```

    3. Create app/(auth)/login/page.tsx with login form (from research code example):
       ```typescript
       'use client'

       import { useActionState } from 'react'
       import { login, LoginState } from './actions'
       import { Button } from '@/components/ui/button'
       import { Input } from '@/components/ui/input'
       import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'

       export default function LoginPage() {
         const [state, formAction, isPending] = useActionState<LoginState | undefined, FormData>(
           login,
           undefined
         )

         return (
           <Card className="w-full max-w-md">
             <CardHeader className="space-y-1">
               <CardTitle className="text-2xl font-bold">PPC Dashboard</CardTitle>
               <CardDescription>
                 Enter your password to access the dashboard
               </CardDescription>
             </CardHeader>
             <CardContent>
               <form action={formAction} className="space-y-4">
                 <div className="space-y-2">
                   <Input
                     type="password"
                     name="password"
                     placeholder="Enter password"
                     required
                     disabled={isPending}
                   />
                   {state?.errors?.password && (
                     <p className="text-sm text-red-500">{state.errors.password[0]}</p>
                   )}
                   {state?.error && (
                     <p className="text-sm text-red-500">{state.error}</p>
                   )}
                 </div>

                 <Button type="submit" className="w-full" disabled={isPending}>
                   {isPending ? 'Signing in...' : 'Sign In'}
                 </Button>
               </form>
             </CardContent>
           </Card>
         )
       }
       ```

    4. Create components/logout-button.tsx (reusable logout button):
       ```typescript
       'use client'

       import { logout } from '@/app/(auth)/login/actions'
       import { Button } from '@/components/ui/button'

       export function LogoutButton() {
         return (
           <form action={logout}>
             <Button type="submit" variant="ghost">
               Logout
             </Button>
           </form>
         )
       }
       ```

    5. Add shadcn card component if not already added:
       ```bash
       npx shadcn@latest add card
       ```
  </action>
  <verify>
    - Visit http://localhost:3001/login shows login form
    - Submitting wrong password shows "Invalid password" error
    - Submitting correct password (from PPC_DASHBOARD_PASSWORD env var) redirects to /dashboard
    - Session cookie appears in browser DevTools > Application > Cookies
  </verify>
  <done>Login page works with password validation, session creation, and error handling</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Unauthenticated visit to / redirects to /login
2. Unauthenticated visit to /dashboard redirects to /login
3. Login with wrong password shows error, stays on /login
4. Login with correct password redirects to /dashboard
5. Session cookie is set after successful login
6. Authenticated visit to /login redirects to /dashboard
</verification>

<success_criteria>
- AUTH-01: User can log in with password set via PPC_DASHBOARD_PASSWORD env var
- AUTH-04: Unauthenticated users are redirected to login page
- Middleware correctly guards all protected routes
- Server actions handle login/logout with proper session management
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-02-SUMMARY.md`
</output>
