# Plan 02-03: Token Refresh & Profile Selection

## Goal
Implement automatic token refresh and profile selection.

## Requirements Covered
- AMZN-03: App automatically refreshes access token before expiry without race conditions
- AMZN-04: User can view token health in settings
- AMZN-05: User can select Amazon advertising profile after OAuth connection

## Tasks

### 1. Implement Token Refresh with Mutex
**File**: `lib/amazon.ts` (extend)

- Check token expiry before API calls
- Refresh 5 minutes before expiry
- Use simple file-based or memory mutex for race condition prevention
- Update database with new tokens

### 2. Create Profile List API
**File**: `app/api/amazon/profiles/route.ts`

GET endpoint that:
- Refreshes token if needed
- Calls Amazon API to list profiles
- Returns profile list

### 3. Create Profile Selection API
**File**: `app/api/amazon/profiles/select/route.ts`

POST endpoint that:
- Receives selected profile ID
- Updates AmazonCredential with profile info
- Returns success

### 4. Add Profile Selection UI
**File**: `app/(dashboard)/settings/page.tsx` (extend)

- Show profile dropdown after OAuth connection
- Display current selected profile
- Allow profile change

### 5. Add Token Health Display
**File**: `app/(dashboard)/settings/page.tsx` (extend)

Display:
- Connection status (connected/disconnected)
- Last token refresh time
- Token expiry countdown
- Selected profile name/marketplace

### 6. Implement Rate Limiter Skeleton
**File**: `lib/rate-limiter.ts`

Token bucket implementation:
- 10 req/sec burst
- 2 req/sec sustained
- Will be used by sync operations in Phase 3

## Verification
- [ ] Token refreshes automatically before expiry
- [ ] Profile list loads after OAuth connection
- [ ] User can select and save profile
- [ ] Token health shows accurate status
- [ ] Rate limiter enforces limits

## Estimated Complexity
Medium-High - Token refresh logic and multiple UI components.
